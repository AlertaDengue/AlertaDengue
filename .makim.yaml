backend: bash
env-file: .envs/.env
groups:

  clean:
    tasks:
      tmp:
        help: remove build artifacts, compiled files, and cache
        backend: bash
        run: |
          find . -name '*.egg-info' -exec rm -rf {} +
          find . -name '*.egg' -exec rm -f {} +
          find . -name '*.pyc' -exec rm -f {} +
          find . -name '*.pyo' -exec rm -f {} +
          find . -name '__pycache__' -exec rm -rf {} +
          find . -name '*~' -exec rm -f {} +
          rm -rf build/
          rm -rf dist/
          rm -rf .eggs/
          rm -f .coverage
          rm -rf htmlcov/
          rm -rf .pytest_cache
          rm -rf .mypy_cache
          rm -rf .ruff_cache
          rm -rf .cache/
          find . -name "*.pyc" -delete
          echo "[II] Cleaned temporary files."
  # DJANGO
  django:
    env-file: .envs/.env
    help: Run Django commands and manage the development server.
    env:
      sugar_run_rm: sugar run --service web --options --rm
      manage_py: python manage.py
    tasks:
      # DEV MODE
      run:
        help: Start the development server locally.
        args:
          subcommand:
            help: Specify a Django subcommand to run.
            type: string
            default: runserver
        run: |
          cd AlertaDengue &&
          ${{ env.manage_py }} ${{ args.subcommand }}

      shell:
        help: Run the Django console interpreter inside the container.
        env-file: .envs/.env
        env:
          POSTGRES_HOST: localhost
          REDIS_HOST: localhost
        run: |
          sugar compose-ext start --services web -- -d
          python AlertaDengue/manage.py shell


      # CONTAINER
      collectstatic:
        help: Run the collectstatic for the backend service
        env-file: .envs/.env
        run: |
          CMD="python manage.py collectstatic --no-input"

          sugar --profile ${ENV} compose-ext start \
            --services postgres -- -d

          CMD="python manage.py collectstatic --no-input"
          sugar --profile ${{ env.ENV }}  compose-ext exec --service web --cmd "$CMD"
          echo "[II] postgres is running."

      static-geofiles:
        help: Generate geojson files and save them in the staticfiles folder.
        run: |
          ${{ env.sugar_run_rm }} --entrypoint "/opt/entrypoint.sh" --cmd ${{ env.manage_py }} sync_geofiles

      makemigrations:
        help: Run django makemigrations command (just for development)
        args:
          check:
            help: |
              Just check if the latest migration files were already created.
            type: bool
            action: store_true
        env-file: .envs/.env
        run: |
          sugar compose-ext start \
            --services postgres -- -d

          CWD=$(pwd)
          CMD_FLAG="${{ '--check' if args.check else '' }} --no-input"

          for app in 'dbf'; do
            echo -e "\nMaking migration files for: '${app}' ...\n"

            CMD="python manage.py makemigrations ${CMD_FLAG} ${app}"

            sugar --profile dev compose-ext run --rm --service web \
              --cmd "$CMD"

            echo "[II] postgres is running."


          done

          echo "[II] postgres is running."

      migrate:
        help: Migrate regarding to the current migration files
        env-file: .envs/.env
        run: |
          sugar compose-ext start \
            --services postgres -- -d

          CMD="python manage.py migrate --no-input"
          sugar --profile dev compose-ext run --rm --service web \
           --cmd "$CMD"

          echo "[II] postgres is running."


      send-mail-partner:
        help: Send email to partners.
        run: |
          ${{ env.sugar_run_rm }} --cmd ${{ env.manage_py }} send_mail

  # TESTS
  tests:
    help: Test tasks (dbdata TDD slice)
    env-file: .envs/.env
    tasks:
      setup:
        help: Setup infra for tests
        run: |
          sugar --profile dev compose-ext start --services postgres --options -d
          makim develop.container-wait --service postgres --timeout 90

      teardown:
        help: Teardown infra for tests
        run: |
          sugar --profile dev compose-ext stop

      lint:
        help: Run linter tools
        hooks:
          pre-run:
            - task: clean.tmp
        run: |
          pre-commit install
          pre-commit run --all-files --verbose

      typecheck:
        help: Run mypy (best-effort, skip third-party imports)
        run: |
          mypy --follow-imports=skip --ignore-missing-imports \
            AlertaDengue/tests

      unit:
        help: Run tests with pytest (inside web container)
        args:
          path:
            help: Path or module to run (e.g., tests/dbdata)
            type: string
            default: "tests/"
          settings:
            help: Django settings module
            type: string
            default: "ad_main.settings.testing"
          params:
            help: Additional pytest params
            type: string
            default: "-vv"
        env-file: .envs/.env
        env:
          POSTGRES_HOST: localhost
          REDIS_HOST: localhost
        hooks:
          pre-run:
            - task: tests.setup
          post-run:
            - task: tests.teardown
        run: |
          TTY_OPT=""
          if [ ! -t 0 ]; then
            TTY_OPT="-T"
          fi

          CMD="PYTHONPATH=/opt/services/AlertaDengue \
            DJANGO_SETTINGS_MODULE=${{ args.settings }} \
            PGOPTIONS='-c search_path=test_views,public' \
            pytest -q ${{ args.path }} ${{ args.params }}"

          sugar --profile dev compose-ext run --rm --service web \
            --options "$TTY_OPT" \
            --cmd "sh -lc \"$CMD\""

  develop:
    env-file: .envs/.env
    help: Development tasks and utilities.
    env:
      manage_py: python AlertaDengue/manage.py
    tasks:
      # CI
      container-wait:
        help: Wait for a specific service to become available.
        args:
          timeout:
            help: Define the timeout in seconds for the health check.
            type: string
            default: "30"
          service:
            help: Specify the name of the service to wait for.
            type: string
            required: true
        run: |
          timeout ${{ args.timeout }} ./containers/scripts/healthcheck.sh ${{ args.service }}

      container-wait-all:
        env-file: .envs/.env
        help: Wait until container is healthy
        args:
          timeout:
            help: the time (in seconds) for waiting the service
            type: string
            default: "90"
            required: false
        hooks:
          pre-run:
            - task: develop.container-wait
              args:
                timeout: ${{ args.timeout }}
                service: postgres
            - task: develop.container-wait
              args:
                timeout: ${{ args.timeout }}
                service: memcached
            - task: develop.container-wait
              args:
                timeout: ${{ args.timeout }}
                service: rabbitmq
            - task: develop.container-wait
              args:
                timeout: ${{ args.timeout }}
                service: web
            - task: develop.container-wait
              args:
                timeout: ${{ args.timeout }}
                service: celery

      clean:
        help: Clean all generated artifacts from the project.
        hooks:
          pre-run:
            - task: develop.clear_cache
        args:
          path:
            help: Specify the path of the files to remove.
            type: string
            default: ""
        run: |
          import shutil
          from pathlib import Path
          base_dir = Path(".")
          list_to_cache_files = [
            'build/', 'dist/', '.eggs/', '*/.eggs', 'db',
            '*.egg-info', '*.egg', '*.pyc', '*.pyo', '*~',
            '__pycache__', '*.ipynb_checkpoints', '*.pytest_cache'
          ]
          for item in list_to_cache_files:
            for file in base_dir.glob(f'**/{item}'):
              shutil.rmtree(file) if file.is_dir() else file.unlink()
      clear_cache:
        help: Clear all Django cache
        args:
          subcommand:
            help: Specify a Django subcommand to run.
            type: string
            default: clearcache
        run: |
          ${{ env.manage_py }} ${{ args.subcommand }}

  ingestion:
    help: SINAN ingestion pipeline (host-side, Strategy A).
    env-file: .envs/.env
    env:
      manage_py: python AlertaDengue/manage.py
      ingestion_host_base: "${DOCKER_HOST_IMPORTED_FILES_DIR}"
      ingestion_worker_base: "/opt/services/ingestion/sinan/imported"
    tasks:
      move:
        help: Move CSV/DBF files to canonical imported path.
        args:
          paths:
            help: Files or directories to process.
            type: string
            required: true
          imported-base:
            help: Destination base directory.
            type: string
            default: ""
          uploaded-base:
            help: Extra base for collision checks.
            type: string
            default: ""
          manifest:
            help: Write a JSON manifest of moved files to this path.
            type: string
            default: ""
          dry-run:
            help: Print planned actions without moving.
            type: bool
            action: store_true
          include-uf:
            help: Include UF folder layer when available.
            type: bool
            action: store_true
          country:
            help: Override country code (e.g. br, es).
            type: string
            default: ""
          on-exists:
            help: "Collision policy: version, skip, or error."
            type: string
            default: version
          include-existing:
            help: Include files in manifest even if they were already moved.
            type: bool
            action: store_true
          epiweek-window:
            help: Skip files older than this number of weeks.
            type: string
            default: "58"
          allow-outdated:
            help: Ingest even if the file is older than the window.
            type: bool
            action: store_true
        run: |
          IMPORTED_BASE=${{ args.imported_base }}
          if [ -z "$IMPORTED_BASE" ]; then
            IMPORTED_BASE="${{ env.DOCKER_HOST_IMPORTED_FILES_DIR }}"
          fi

          UPLOADED_BASE=${{ args.uploaded_base }}
          if [ -z "$UPLOADED_BASE" ]; then
            UPLOADED_BASE="${{ env.DOCKER_HOST_UPLOADED_FILES_DIR }}"
          fi

          FLAGS=""
          FLAGS="$FLAGS --imported-base $IMPORTED_BASE"
          FLAGS="$FLAGS --uploaded-base $UPLOADED_BASE"
          if [ -n "${{ args.manifest }}" ]; then
            FLAGS="$FLAGS --manifest ${{ args.manifest }}"
          fi
          if [ "${{ args.dry_run }}" = "True" ]; then
            FLAGS="$FLAGS --dry-run"
          fi
          if [ "${{ args.include_uf }}" = "True" ]; then
            FLAGS="$FLAGS --include-uf"
          fi
          if [ -n "${{ args.country }}" ]; then
            FLAGS="$FLAGS --country ${{ args.country }}"
          fi
          if [ "${{ args.include_existing }}" = "True" ]; then
            FLAGS="$FLAGS --include-existing"
          fi
          if [ -n "${{ args.epiweek_window }}" ]; then
            FLAGS="$FLAGS --epiweek-window ${{ args.epiweek_window }}"
          fi
          if [ "${{ args.allow_outdated }}" = "True" ]; then
            FLAGS="$FLAGS --allow-outdated"
          fi
          FLAGS="$FLAGS --on-exists ${{ args.on_exists }}"

          python AlertaDengue/ingestion/management/commands/mover_sinan_data.py \
            "${{ args.paths }}" \
            --imported-base $IMPORTED_BASE \
            --uploaded-base $UPLOADED_BASE \
            $FLAGS

      enqueue:
        help: Create a Run record and enqueue Celery processing.
        hooks:
          pre-run:
            - task: develop.container-wait
              args:
                service: postgres
                timeout: "30"
            - task: develop.container-wait
              args:
                service: rabbitmq
                timeout: "30"
        args:
          source-path:
            help: Path to the source file (CSV/DBF/Parquet).
            type: string
            required: true
          uf:
            help: UF code (e.g. ES, BR).
            type: string
            required: true
          disease:
            help: CID10 disease code (e.g. A90, A92).
            type: string
            required: true
          year:
            help: Delivery year.
            type: string
            required: true
          week:
            help: Delivery epidemiological week.
            type: string
            required: true
          requeue:
            help: Re-enqueue even if run already exists.
            type: bool
            action: store_true
        env:
          PSQL_HOST: "localhost"
          PSQL_PORT: "${{ env.PSQL_PORT }}"
          CELERY_BROKER_URL: "${{ env.CELERY_BROKER_URL }}"
        run: |
          FLAGS=""
          if [ "${{ args.requeue }}" = "True" ]; then
            FLAGS="$FLAGS --requeue"
          fi
          if [ -n "${{ env.ingestion_host_base }}" ]; then
            FLAGS="$FLAGS --host-base ${{ env.ingestion_host_base }}"
            FLAGS="$FLAGS --worker-base ${{ env.ingestion_worker_base }}"
          fi

          cd AlertaDengue &&
          python manage.py ingestion_enqueue_sinan \
            "${{ args.source_path }}" \
            --uf "${{ args.uf }}" \
            --disease "${{ args.disease }}" \
            --year "${{ args.year }}" \
            --week "${{ args.week }}" \
            $FLAGS

      enqueue-manifest:
        help: Read a manifest and enqueue runs in priority order (ES < BR, earlier weeks first).
        hooks:
          pre-run:
            - task: develop.container-wait
              args:
                service: postgres
                timeout: "30"
            - task: develop.container-wait
              args:
                service: rabbitmq
                timeout: "30"
        args:
          manifest:
            help: Path to the JSON manifest from mover_sinan_data.py.
            type: string
            required: true
          requeue:
            help: Re-enqueue even if run already exists.
            type: bool
            action: store_true
          dry-run:
            help: Print the sorted plan without enqueuing.
            type: bool
            action: store_true
        env:
          PSQL_HOST: "localhost"
          PSQL_PORT: "${{ env.PSQL_PORT }}"
          CELERY_BROKER_URL: "${{ env.CELERY_BROKER_URL }}"
        run: |
          FLAGS=""
          if [ "${{ args.requeue }}" = "True" ]; then
            FLAGS="$FLAGS --requeue"
          fi
          if [ "${{ args.dry_run }}" = "True" ]; then
            FLAGS="$FLAGS --dry-run"
          fi
          if [ -n "${{ env.ingestion_host_base }}" ]; then
            FLAGS="$FLAGS --host-base ${{ env.ingestion_host_base }}"
            FLAGS="$FLAGS --worker-base ${{ env.ingestion_worker_base }}"
          fi

          cd AlertaDengue &&
          python manage.py ingestion_enqueue_manifest \
            --manifest "${{ args.manifest }}" \
            $FLAGS

      run:
        help: Full pipeline — move files then enqueue via manifest.
        hooks:
          pre-run:
            - task: develop.container-wait
              args:
                service: postgres
                timeout: "30"
            - task: develop.container-wait
              args:
                service: rabbitmq
                timeout: "30"
        args:
          paths:
            help: Files or directories to move.
            type: string
            required: true
          imported-base:
            help: Destination base directory.
            type: string
            default: ""
          uploaded-base:
            help: Extra base for collision checks.
            type: string
            default: ""
          dry-run:
            help: Print planned actions without executing.
            type: bool
            action: store_true
          requeue:
            help: Re-enqueue even if run already exists.
            type: bool
            action: store_true
          include-existing:
            help: Include files in manifest even if they were already moved.
            type: bool
            action: store_true
          epiweek-window:
            help: Skip files older than this number of weeks.
            type: string
            default: "58"
          allow-outdated:
            help: Ingest even if the file is older than the window.
            type: bool
            action: store_true
        env:
          PSQL_HOST: "localhost"
          PSQL_PORT: "${{ env.PSQL_PORT }}"
          CELERY_BROKER_URL: "${{ env.CELERY_BROKER_URL }}"
        run: |
          UPLOADED_BASE=${{ args.uploaded_base }}
          if [ -z "$UPLOADED_BASE" ]; then
            UPLOADED_BASE="${{ env.DOCKER_HOST_UPLOADED_FILES_DIR }}"
          fi

          IMPORTED_BASE=${{ args.imported_base }}
          if [ -z "$IMPORTED_BASE" ]; then
            IMPORTED_BASE="${{ env.DOCKER_HOST_IMPORTED_FILES_DIR }}"
          fi

          MANIFEST_FILE=$(mktemp --suffix=.json)

          MOVE_FLAGS=""
          MOVE_FLAGS="$MOVE_FLAGS --imported-base $IMPORTED_BASE"
          MOVE_FLAGS="$MOVE_FLAGS --uploaded-base $UPLOADED_BASE"
          if [ "${{ args.dry_run }}" = "True" ]; then
            MOVE_FLAGS="$MOVE_FLAGS --dry-run"
          fi
          MOVE_FLAGS="$MOVE_FLAGS --manifest $MANIFEST_FILE"

          echo "── Phase 1: Moving files ──"
          if [ "${{ args.include_existing }}" = "True" ]; then
            MOVE_FLAGS="$MOVE_FLAGS --include-existing"
          fi
          if [ -n "${{ args.epiweek_window }}" ]; then
            MOVE_FLAGS="$MOVE_FLAGS --epiweek-window ${{ args.epiweek_window }}"
          fi
          if [ "${{ args.allow_outdated }}" = "True" ]; then
            MOVE_FLAGS="$MOVE_FLAGS --allow-outdated"
          fi
          python AlertaDengue/ingestion/management/commands/mover_sinan_data.py \
            "${{ args.paths }}" $MOVE_FLAGS

          if [ "${{ args.dry_run }}" = "True" ]; then
            echo "Dry-run mode — skipping enqueue."
            cat "$MANIFEST_FILE"
            rm -f "$MANIFEST_FILE"
            exit 0
          fi

          ENQUEUE_FLAGS=""
          if [ "${{ args.requeue }}" = "True" ]; then
            ENQUEUE_FLAGS="$ENQUEUE_FLAGS --requeue"
          fi
          if [ -n "${{ env.ingestion_host_base }}" ]; then
            ENQUEUE_FLAGS="$ENQUEUE_FLAGS --host-base ${{ env.ingestion_host_base }}"
            ENQUEUE_FLAGS="$ENQUEUE_FLAGS --worker-base ${{ env.ingestion_worker_base }}"
          fi

          echo "── Phase 2: Enqueueing from manifest ──"
          cd AlertaDengue &&
          python manage.py ingestion_enqueue_manifest \
            --manifest "$MANIFEST_FILE" \
            $ENQUEUE_FLAGS

          if [ ! -s "$MANIFEST_FILE" ]; then
            echo "[WW] Manifest is empty after Phase 1. If files were skipped because they already exist, use --include-existing to force re-ingestion/manifest inclusion."
          fi
          rm -f "$MANIFEST_FILE"

      watch:
        help: Watch a directory for new SINAN files and trigger ingestion.
        args:
          path:
            help: Directory to watch.
            type: string
            default: ""
          settle-time:
            help: Wait N seconds after last modification to ensure upload is finished.
            type: string
            default: "5.0"
          requeue:
            help: Re-enqueue even if run already exists.
            type: bool
            action: store_true
          include-existing:
            help: Include files in manifest even if they were already moved.
            type: bool
            action: store_true
        run: |

          INCOMING_DIR="${{ args.path }}"
          if [ -z "$INCOMING_DIR" ]; then
            INCOMING_DIR="${{ env.DOCKER_HOST_INCOMING_DIR }}"
          fi

          FLAGS=""
          if [ "${{ args.requeue }}" = "True" ]; then
            FLAGS="$FLAGS --requeue"
          fi
          if [ "${{ args.include_existing }}" = "True" ]; then
            FLAGS="$FLAGS --include-existing"
          fi

          python AlertaDengue/ingestion/management/commands/ingestion_watcher.py \
            --path "${INCOMING_DIR}" \
            --settle-time '${{ args.settle_time }}' \
            $FLAGS

  release:
    vars:
      app: |
        npx --yes \
          -p semantic-release \
          -p conventional-changelog-conventionalcommits \
          -p "@semantic-release/commit-analyzer" \
          -p "@semantic-release/release-notes-generator" \
          -p "@semantic-release/changelog" \
          -p "@semantic-release/exec" \
          -p "@semantic-release/github" \
          -p "@semantic-release/git" \
          -p "semantic-release-replace-plugin@1.2.7" \
          semantic-release

    tasks:
      ci:
        help: run semantic release on CI
        run: ${{ vars.app }} --ci

      dry:
        help: run semantic release in dry-run mode
        run: |
          ${{ vars.app }} --dry-run
