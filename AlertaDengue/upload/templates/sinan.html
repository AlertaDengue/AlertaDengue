{% extends 'base.html' %}
{% load i18n %}
{% load bootstrap4 %}
{% load static %}

{% block extra_head %}
  <script src='{% static "/libs/jquery/jquery-ui.min.js" %}'></script>
  <script>
  $(document).ready( function() {
    $("#id_export_date").datepicker({dateFormat: "yy-mm-dd"});
    window.form_has_changed = false;
    var ask_confirmation = function() {
      return window.form_has_changed;
    };

    window.addEventListener("beforeunload", function (e) {
      if (!ask_confirmation()) {
        return undefined;
      }

      var confirmationMessage = 'Existem alterações no formulário. Se você sair agora '
        + 'todas as alterações serão perdidas.';

      (e || window.event).returnValue = confirmationMessage;
      return confirmationMessage;
    });

    $("#submit_button").click(function(e) {
      window.form_has_changed = false;
    });
  });
  </script>

  <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
  <script src='{% static "/libs/jquery/jquery.iframe-transport.js" %}'></script>
  <!-- The basic File Upload plugin -->
  <script src='{% static "/libs/jquery/jquery.fileupload.js" %}'></script>
  <!-- Calculate md5 -->
  <script src='{% static "/js/spark-md5.js" %}'></script>
  {% endblock %}

  {% block title %}Envio de dados atualizados do SINAN{% endblock %}

  {% block content %}
  <div class="panel panel-default col-xs-6">
    <div class="panel-body">
      <form>
        <div class="form-group">
          {% csrf_token %}
          <input id="chunked_upload" type="file" name="file">
        </div>
        <div class="form-group">
          <label id="filename_display" style="display: none;">
            <span></span>
          </label>
          <div class="progress" style="display: none;">
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
              <span></span>
            </div>
          </div>
        </div>
      </form>

      <form method="POST" enctype="multipart/form-data" action='{% url "upload:sinan" %}'>
        {% csrf_token %}
        {% bootstrap_form form %}
        {% buttons %}
        <button type="submit" id="submit_button" class="btn btn-primary" disabled="disabled">
          {% translate "Enviar" %}
        </button>
        {% endbuttons %}
      </form>
    </div>

    <div>
      <div class="panel-body">
        <p>{% translate "Ultimos arquivos enviados:" %}</p>
        <ul>
          {% for upload in last_uploaded %}
          <li>{{ upload }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <script src="{% static '/js/upload/sinan.js' %}" type="text/javascript"></script>
  <link rel="stylesheet" href="{% static '/css/upload/sinan.css' %}" type="text/css">
{% endblock %}
