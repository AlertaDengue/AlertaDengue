{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load lookup %}

{% block extra_head %}
<meta property="og:image"
      content="http://info.dengue.mat.br/static/img/screenshot.png"/>
<meta property="og:image:secure_url"
      content="https://info.dengue.mat.br/static/img/screenshot.png"/>


<script src="/static/libs/bootstrap-select/bootstrap-select.min.js"
        type="text/javascript"></script>

<script src="/static/js/infodengue.js"
        type="text/javascript"></script>

<link href="/static/libs/bootstrap-select/bootstrap-select.min.css"
        type="text/css" rel="stylesheet" />


<style type="text/css">
    .form .col-head {
        text-align: right;
        font-weight: bold;
        vertical-align: middle;
    }

    .form .row {
        padding: 5px;
    }

    .word-break {
        word-break: break-all;
    }

    .hidden {
        display: none;
    }
</style>

<script>
    function geocode_search() {

        var cond = '[value^="' + $('#geocode-search').val() + '"]';

        $('#geocode').prop('selectedIndex',0);

        $('#geocode option').not(cond).prop('disabled', true);
        $('#geocode option').not(cond).addClass('hidden');
        $('#geocode option' + cond).prop('disabled', false);
        $('#geocode option' + cond).removeClass('hidden');

        if ($('#geocode option[disabled!="disabled"]').length == 1) {
            $('#geocode option[disabled!="disabled"]').prop('selected', true);
        }
    }
</script>

{% endblock %}

{% block title %}{% trans "Serviços de Dados Públicos" %}: {% trans "Mapas" %}{% endblock %}

{% block content %}


<div class="container">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <a href="/data-public-services/maps/doc">
                    {% trans "Para mais informações, acesse a documentação do serviço de mapas." %}
                </a>
            </div>

            <div class="form-group">
                <label for="geocode-search">{% trans "Filtro Código IBGE" %}:</label>

                <input id="geocode-search" type="text" maxlength="7"
                       class="form-control  input-sm"
                       placeholder='{% trans "Digite aqui para filtrar as opções do código IBGE." %}'
                       oninput="geocode_search();"
                       aria-describedby="geocode-searchHelp"
                />

                <small id="geocode-searchHelp" class="form-text text-muted">
                  {% trans "Digite o código IBGE ou parte dele para buscar o código IBGE disponível." %}
                </small>
            </div>

            <div class="form-group">
                <label for="geocode">{% trans "Código IBGE" %}:</label>

                <select id="geocode"
                        class="form-control"
                        data-live-search="true"
                        data-title="{% blocktrans %}Selecione municipio(s){% endblocktrans %}"
                        data-actions-box="true"
                        data-selected-text-format="static"
                        aria-describedby="geocodeHelp"
                >
                    <option value="">{% trans "Selecione o código IBGE da cidade desejada" %}</option>>
                    {% for k in geocodes %}
                    <option value="{{k}}">{{k}}</option>
                    {% endfor %}
                </select>

                <small id="geocodeHelp" class="form-text text-muted">
                  {% trans "Selecione o município desejado para a consulta" %}
                </small>
            </div>
            <div class="form-group">
                <label for="map">{% trans "Mapa" %}:</label>

                <select id="map" aria-describedby="mapHelp" class="form-control" >
                    <option value="/maps/alert/dengue.map">
                        {% trans "Alerta Dengue" %}
                    </option>
                    <option value="/maps/alert/chikungunya.map">
                        {% trans "Alerta Chikungunya" %}
                    </option>
                    <option value="/maps/alert/zika.map">
                        {% trans "Alerta Zika" %}
                    </option>
                    <option value="/maps/meteorological/ndvi.map">
                        {% trans "NDVI" %}
                    </option>
                    <option value="/maps/meteorological/lst_day_1km.map">
                        {% trans "LST Dia" %}
                    </option>
                    <option value="/maps/meteorological/lst_night_1km.map">
                        {% trans "LST Noite" %}
                    </option>
                    <option value="/maps/meteorological/relative_humidity_2m_above_ground.map">
                        {% trans "Umidade Relativa" %}
                    </option>
                    <option value="/maps/meteorological/specific_humidity_2m_above_ground.map">
                        {% trans "Umidade Específica" %}
                    </option>
                    <option value="/maps/meteorological/precipitation">
                        {% trans "Precipitação" %}
                    </option>
                </select>

                <small id="mapHelp" class="form-text text-muted">
                  {% trans "Selecione o tipo de mapa desejado" %}
                </small>
            </div>
            <div class="form-group">
                <label>{% trans "Tipo de imagem de saída" %}:</label>
                <select id="image-format"
                        class="form-control"
                        aria-describedby="image-formHelp"
                >
                    <option value="png">PNG</option>
                    <option value="GTiff">GeoTIFF</option>
                    <option value="kml">KML</option>
                </select>
                <small id="image-formatHelp" class="form-text text-muted">
                  {% trans "Selecione o Tipo de imagem de saída" %}
                </small>
            </div>
            <div class="form-group">
                <label>{% trans "Dimensão de ajuste:" %}:</label>
                <select id="dimension-name"
                        class="form-control"
                        aria-describedby="dimension-nameHelp"
                >
                    <option value="width">Width (px)</option>
                    <option value="height">Height (px)</option>
                </select>
                <small id="dimension-nameHelp" class="form-text text-muted">
                  {% trans "Dimensão de ajuste da imagem" %}
                </small>
            </div>
            <div class="form-group">
                <label>{% trans "Valor da dimensão selecionada" %}:</label>
                <input id="dimension-value" value="800"
                       class="form-control"
                       maxlength="6"
                       max="999999"
                       aria-describedby="dimension-valueHelp"
                />
                <small id="dimension-valueHelp" class="form-text text-muted">
                  {% trans "Selecione o valor para a dimensão informada" %}
                </small>
            </div>
            <div class="row">
                <div class="col-md-12 column py-3" id="message-url">
                </div>
            </div>
            <div class="form-group">
                <input type="button" class="btn btn-primary"
                       value='{% trans "Gerar URL do serviço" %}'
                       onclick="generate_url();"
                />
            </div>
        </div>
    </div>
</div>

<script>
    var geo_info = {{geo_info|safe}};

    function generate_url() {
        var url = (
            '{{mapserver_url}}/?map=<map>&' +
            'SERVICE=WMS&' +
            'VERSION=1.3.0&'+
            'REQUEST=GetMap&' +
            'LAYERS=<geocode>&' +
            'CRS=CRS:84&' +
            'BBOX=<bbox>&' +
            'WIDTH=<width>&' +
            'HEIGHT=<height>&' +
            'FORMAT=<image-format>'
        );
        var geocode = $('#geocode').val();

        if (!(geocode in geo_info)) {
            return alert('Código IBGE não encontrado.');
        }

        var dimension_name = $('#dimension-name option:selected').val();
        var dimension_value = parseInt($('#dimension-value').val());
        // parse to int
        $('#dimension-value').val(dimension_value);

        if (!dimension_value > 0) {
            return alert('Informe uma valor > 0 para o campo ' + dimension_name);
        }

        var geo_info_i = geo_info[geocode];
        var bounds = geo_info_i['bounds'][0] + ',' +
            geo_info_i['bounds'][1] + ',' +
            geo_info_i['bounds'][2] + ',' +
            geo_info_i['bounds'][3];
        var width = geo_info_i['width'];
        var height = geo_info_i['height'];

        var width_i;
        var height_i;
        var factor;

        if (dimension_name == 'width') {
            factor = height/width;
            width_i = dimension_value;
            height_i = dimension_value*factor;
        } else {
            factor = width/height;
            width_i = dimension_value*factor;
            height_i = dimension_value;
        }

        url = url.replace('<map>', $('#map option:selected').val());
        url = url.replace('<geocode>', geocode);
        url = url.replace('<bbox>', bounds);
        url = url.replace('<width>', width_i);
        url = url.replace('<height>', height_i);
        url = url.replace('<image-format>', $('#image-format option:selected').val());

        $('#message-url').html('<a href="' + url + '" class="word-break">' + url + '</a>');
    }



</script>
{% endblock %}
