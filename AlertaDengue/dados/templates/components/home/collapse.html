{% load i18n %}
{% load lookup %}
{% load hashthis %}

{% block regional_collapse_component %}

<div class="card mb-0 p-0 home-section-card"
     style="background-color:#e0eefd63;border-radius:7px;
            box-shadow:2px 2px 7px #0c1b2b69;"
     id="state-epi-card">
  <div class="card-header home-section-header d-flex flex-column flex-md-row
              align-items-md-center justify-content-between">
    <div>
      <h3 class="mb-1">
        {% trans "Situação epidemiológica por estado" %}
      </h3>
      <p class="small text-muted mb-0">
        {% trans "Selecione um estado para visualizar mapas de incidência, número de casos ou situação epidemiológica dos municípios." %}
      </p>
    </div>

    <div class="d-flex flex-column align-items-md-end mt-3 mt-md-0">
      <div class="state-epi-select-wrapper">
        <select id="state-select"
                class="form-control state-epi-select">
          <option value="">
            {% trans "Selecione um estado" %}
          </option>
          {% for abbr, name in states_name.items %}
            <option value="{{ abbr }}"{% if abbr == 'CE' %} selected{% endif %}>
              {{ name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <span id="state-status-badge"
            class="badge-state badge-state--neutral mt-2">
      </span>
    </div>
  </div>

  <div class="card-body">
    <div id="state-chart-panel" class="state-chart-panel">
      <p class="text-muted mb-0">
        {% trans "Selecione um estado no campo acima para visualizar os gráficos de incidência." %}
      </p>
    </div>
  </div>
</div>

{% endblock %}

<script type="text/javascript">
  (function ($) {
    $(function () {
      var $select = $('#state-select');
      var $panel = $('#state-chart-panel');
      var $card = $('#state-epi-card');

      function scrollToCard() {
        if ($card.length && window.matchMedia('(max-width: 767px)').matches) {
          $card[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      $select.on('change', function () {
        var state = $(this).val();

        if (!state) {
          $panel.html(
            '<p class="text-muted mb-0">' +
              '{% trans "Selecione um estado no campo acima para visualizar os gráficos de incidência." %}' +
            '</p>'
          );
          return;
        }

        $.ajax({
          url: '/chartshome/' + state,
          method: 'GET',
          dataType: 'html'
        })
        .done(function (data) {
          $panel.html(data);
          scrollToCard();
        })
        .fail(function () {
          $panel.html(
            '<div class="alert alert-danger mb-0">' +
              '{% trans "Não foi possível carregar os dados deste estado." %}' +
            '</div>'
          );
        });
      });
    });
  })(jQuery);
</script>

<script type="text/javascript">
  (function ($) {
    $(function () {
      var $select = $('#state-select');
      var $panel = $('#state-chart-panel');
      var $card = $('#state-epi-card');
      var defaultState = 'RJ';

      function scrollToCard() {
        if ($card.length && window.matchMedia('(max-width: 767px)').matches) {
          $card[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      $select.on('change', function () {
        var state = $(this).val();

        if (!state) {
          $panel.html(
            '<p class="text-muted mb-0">' +
              '{% trans "Selecione um estado no campo acima para visualizar os gráficos de incidência." %}' +
            '</p>'
          );
          return;
        }

        $.ajax({
          url: '/chartshome/' + state,
          method: 'GET',
          dataType: 'html'
        })
        .done(function (data) {
          $panel.html(data);
          scrollToCard();
        })
        .fail(function () {
          $panel.html(
            '<div class="alert alert-danger mb-0">' +
              '{% trans "Não foi possível carregar os dados deste estado." %}' +
            '</div>'
          );
        });
      });

      if (
        defaultState &&
        $select.find('option[value="' + defaultState + '"]').length
      ) {
        $select.val(defaultState);
        $select.trigger('change');
      }
    });
  })(jQuery);
</script>
