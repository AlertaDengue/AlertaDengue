{% extends 'base.html' %}
{% block extra_head %}
    {% load static %}
    {% load leaflet_tags %}
    {% leaflet_js %}
    {% leaflet_css %}
    {% leaflet_js plugins="ALL" %}
    <style>
        .leaflet-container {
            height: 600px;

        }

        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }

        .legend {
            text-align: left;
            line-height: 18px;
            color: #555;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
    </style>
    <script src="/static/js/heatmap.js"></script>
    <script src="/static/js/heatmap-leaflet.js"></script>
    <script src="/static/js/QuadTree.js"></script>
    <script src='/static/exp_PontosUnidadesBasicasSaudeMRJ2014wgs84.js'></script>
    <script src="/static/js/Autolinker.min.js"></script>
{% endblock %}


{% block title %}Situação da Dengue no Rio de Janeiro{% endblock %}

{% block content %}
    <br>
    <div class="bs-callout bs-callout-warning">
        <h4>Níveis de Atenção</h4>

        <p>
            As cores no mapa abaixo indicam os níveis de atenção em sua região da cidade! Ajude a controlar a Dengue,
            seguindo as recomendações sugeridas!
        </p>
    </div>


    {% leaflet_map "main" callback="main_map_init" %}
    <br>
    {#    <img src="/static/codigocores.jpg" alt="Cores do Alerta" width="1140px">#}
    <div class="row clearfix">
        <div class="col-md-4 column">
            <span class="glyphicon glyphicon-signal" aria-hidden="true"></span><p>Níveis de Atenção</p>

            <div class="panel-group" id="panelgroup">
                <div class="panel panel-default panel-verde">
                    <div class="panel-heading">
                        <a class="panel-title" data-toggle="collapse" data-parent="#panel-222790"
                           href="#panel-element-vd">Nível Verde</a>
                    </div>
                    <div id="panel-element-vd" class="panel-collapse collapse">
                        <div class="panel-body">
                            Sem Risco. Quando o mapa está verde, não existe transmissão e nem condições ideais para a
                            reprodução do Mosquito.
                        </div>
                    </div>
                </div>
                <div class="panel panel-default panel-amarelo">
                    <div class="panel-heading panel-amarelo">
                        <a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-222790"
                           href="#panel-element-am">Nível Amarelo</a>
                    </div>
                    <div id="panel-element-am" class="panel-collapse collapse">
                        <div class="panel-body">
                            Anim pariatur cliche...
                        </div>
                    </div>
                </div>
                <div class="panel panel-default panel-laranja">
                    <div class="panel-heading">
                        <a class="panel-title" data-toggle="collapse" data-parent="#panel-222790"
                           href="#panel-element-la">Nível Laranja</a>
                    </div>
                    <div id="panel-element-la" class="panel-collapse collapse">
                        <div class="panel-body">
                            Anim pariatur cliche...
                        </div>
                    </div>
                </div>
                <div class="panel panel-default panel-vermelho">
                    <div class="panel-heading">
                        <a class="panel-title" data-toggle="collapse" data-parent="#panel-222790"
                           href="#panel-element-vm">Nível Vermelho</a>
                    </div>
                    <div id="panel-element-vm" class="panel-collapse collapse">
                        <div class="panel-body">
                            Anim pariatur cliche...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 column">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span><p>Novos Casos</p>

            <div class="bs-callout bs-callout-primary">
                <p>Foram registrados <b><span class="badge">{{ novos_casos }}</span> novos casos</b> na Semana Epidemiológica {{ SE }}: Semana
                    de {{ data }}.</p>

            </div>
        </div>
        <div class="col-md-4 column">
            <span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span><p>Suspeita de um criadouro de mosquitos? </p>

            <div class="bs-callout bs-callout-primary">
                <p><a href="http://www.1746.rio.gov.br/"><img src="/static/img/1746.jpg" alt="ligue 1746" width="140px"
                                                              align="bottom"></a></p>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        function isInArray(el, array) {
            return (array.indexOf(el) >= 0) ? true : false;
        }

        var aps = L.layerGroup();
        var features = L.layerGroup();
        var info = L.control();
        var legend = L.control({position: 'bottomright'});
        var geojson;


        // get color depending on population density value
        function getColor(d) {
            return d == 3 ? '#FF0205' : // Vermelho
                    d == 2 ? '#E45205' : // Laranja
                            d == 1 ? '#C8D20F' : '#0D6B0D'; // amarelo  e verde
        }

        function style(feature) {
            return {
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7,
                fillColor: getColor(parseInt(feature.properties.alerta))
            };
        }

        function highlightFeature(e) {
            var layer = e.target;

            layer.setStyle({
                weight: 5,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.7
            });


            if (!L.Browser.ie && !L.Browser.opera) {
                layer.bringToFront();
            }

            info.update(layer.feature.properties);
            layer.bringToBack()
        }

        function resetHighlight(e) {
            geojson.resetStyle(e.target);
            info.update();
        }


        function main_map_init(map, options) {
            $(document).data('map', map)
            //map._layersMaxZoom=13
            var dataurl = "{% static 'rio_aps.geojson' %}";
            var casos_por_ap = {{ casos_por_ap|safe }};
            var alerta = {{ alerta|safe }};
            var recomendacoes = {
                0: "Hora de arrumar o quintal, cobrir caixas d'água, <a href='http://www.riocontradengue.rj.gov.br/Site/Conteudo/Eliminar.aspx'>Não deixe criadouros para o mosquito!</a>",
                1: 'Uma vez por semana, aplique os <a href="http://www.riocontradengue.com.br/Site/Conteudo/Checklist.aspx">“10 minutos Contra a dengue”!</a>',
                2: 'Fique <a href="http://www.riocontradengue.rj.gov.br/Site/Conteudo/FiqueAtento.aspx">atento aos sintomas da Dengue!</a> Procure um médico caso suspeite de dengue.',
                3: 'Fique <a href="http://www.riocontradengue.rj.gov.br/Site/Conteudo/FiqueAtento.aspx">atento aos sintomas da Dengue!</a> Procure um médico caso suspeite de dengue.'
            };
            var bairros = {
                1.0: 'Centro e adjacências',
                2.1: 'Zona Sul',
                2.2: 'Tijuca e adjacências',
                3.1: 'Bonsucesso e adjacências',
                3.2: 'Meier e adjacências',
                3.3: 'Madureira e adjacências',
                4.0: 'Barra, Recreio e Jacarepaguá',
                5.1: 'Bangu e adjacências',
                5.2: 'Campo Grande e adjacências',
                5.3: 'Santa Cruz e adjacências'
            };

            // control that shows state info on hover
            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info');
                this.update();
                return this._div;
            };

            info.update = function (props) {
                this._div.innerHTML = '<h4>Número de casos na semana:</h4>' + (props ?
                '<b>' + props.casos + '</b><br />' : 'Passe o mouse sobre uma AP');
            };

            info.addTo(map);

            legend.onAdd = function (map) {

                var div = L.DomUtil.create('div', 'info legend'),
                        grades = [0, 1, 2, 3],
                        nomes = ['Baixo Risco', 'Atenção', 'Transmissão', 'Epidemia'],
                        labels = [],
                        from, to;

                for (var i = 0; i < grades.length; i++) {
                    from = grades[i];
                    to = grades[i + 1];

                    labels.push('<i style="background:' + getColor(from) + '"></i> ' +
                    nomes[from]);
                }
                labels.push('O: Unidades de Saúde');
                div.innerHTML = labels.join('<br>');
                return div;
            };

            legend.addTo(map);
            // fetch data about health units
            function pop_PontosUnidadesBasicasSaudeMRJ2014wgs84(feature, layer) {
                var popupContent = '<table><tr><th scope="row">Nome:</th><td>' + Autolinker.link(String(feature.properties.NOME_LEG)) + '</td></tr><tr><th scope="row">Logradouro:</th><td>' + Autolinker.link(String(feature.properties.LOGRADOURO)) + '</td></tr><tr><th scope="row">Número:</th><td>' + Autolinker.link(String(feature.properties.NUMERO)) + '</td></tr><tr><th scope="row">Complemento:</th><td>' + Autolinker.link(String(feature.properties.COMPLEMENT)) + '</td></tr><tr><th scope="row">Bairro:</th><td>' + Autolinker.link(String(feature.properties.BAIRRO)) + '</td></tr><tr><th scope="row">CEP:</th><td>' + Autolinker.link(String(feature.properties.CEP)) + '</td></tr><tr><th scope="row">Telefone:</th><td>' + Autolinker.link(String(feature.properties.TELEFONE)) + '</td></tr><tr><th scope="row">Tipo:</th><td>' + Autolinker.link(String(feature.properties.TP_UNIDADE)) + '</td></tr><tr><th scope="row">Classe:</th><td>' + Autolinker.link(String(feature.properties.CLASSE_UND)) + '</td></tr></table><p><a href="http://www.rio.rj.gov.br/web/sms/onde-ser-atendido">Onde posso ser atendido?</a></p>';
                layer.bindPopup(popupContent);
            }

            var exp_PontosUnidadesBasicasSaudeMRJ2014wgs84JSON = new L.geoJson(exp_PontosUnidadesBasicasSaudeMRJ2014wgs84, {
                onEachFeature: pop_PontosUnidadesBasicasSaudeMRJ2014wgs84,
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: feature.properties.radius_qgis2leaf,
                        fillColor: feature.properties.color_qgis2leaf,
                        color: '#000',
                        weight: 1,
                        opacity: feature.properties.transp_qgis2leaf,
                        fillOpacity: feature.properties.transp_qgis2leaf
                    })
                }
            });
            features.addLayer(exp_PontosUnidadesBasicasSaudeMRJ2014wgs84JSON)
            // Download GeoJSON via Ajax
            $.getJSON(dataurl, function (data) {
                // Add GeoJSON layer
                geojson = L.geoJson(data, {
                    style: style, onEachFeature: function (feature, layer) {
                        feature.properties.alerta = alerta[parseFloat(feature.properties.COD_AP_SMS)];
                        //feature.properties.alerta = alerta[feature.properties.COD_AP_SMS];
                        feature.properties.casos = casos_por_ap[feature.properties.COD_AP_SMS];
                        layer.bindPopup("<b>" + bairros[parseFloat(feature.properties.COD_AP_SMS)] + "</b>" + "<br>" +
                                "Casos: " + feature.properties.casos + "<br><u>O que fazer</u>: " +
                                recomendacoes[feature.properties.alerta]
                        );
                        layer.setStyle(style(feature))
                        layer.on({
                            mouseover: highlightFeature,
                            mouseout: resetHighlight
                        });

                    }
                });

                aps.addLayer(geojson, true);
                aps.addTo(map);
                features.addTo(map);
            });


            var overlayMaps = {
                'Áreas de Planejamento': aps,
                'Unidades de Saúde': features
            };
            var controls = L.control.layers(null, overlayMaps, {collapsed: true});
            map.dragging.disable();
            map.scrollWheelZoom.disable();
            map.touchZoom.disable();
            map.doubleClickZoom.disable();
            map.boxZoom.disable();
            map.keyboard.disable();
            $(".leaflet-control-zoom").css("visibility", "hidden");
            controls.addTo(map);
            map.touchZoom.disable();
            map.doubleClickZoom.disable();

        }
    </script>

{% endblock %}
