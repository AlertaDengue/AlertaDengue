{% extends 'base.html' %}
{% block extra_head %}
    {% load leaflet_tags %}
    {% leaflet_js %}
    {% leaflet_css %}
    {% leaflet_js plugins="ALL" %}
    <style>
        .leaflet-container {
            height: 600px;
        }
    </style>
{% endblock %}


{% block title %}<br><a href="{% url 'home' %}">Projeto Alerta Dengue</a>{% endblock %}

{% block content %}
    <div id="progress" style="display: none"><div id="progress-bar" style="display: none"></div></div>

    <h1>Casos de Dengue no munic√≠pio do Rio de Janeiro, em <b id="ano">2010</b> segundo SINAN.</h1>
    <b>Year: </b> <select id="year">
    <option value="2010">2010</option>
    <option value="2011">2011</option>
    <option value="2012">2012</option>
    <option value="2013">2013</option>
</select><br>

    {% leaflet_map "main" callback="main_map_init" %}

    <script type="text/javascript">
        var case_layers = L.layerGroup();
        var progress = $("#progress");
        var progressBar = $("#progress-bar");
        $("select").change(function () {
            $(this).find("option:selected").each(function () {
                redraw_map($("#year option:selected").val())
            });
        });
        function redraw_map(year) {
            case_layers.clearLayers();
            var map = $(document).data('map')
            $.getJSON("/sinan/" + year.toString() + "/40", function (data) {
                var markers = L.markerClusterGroup({ spiderfyOnMaxZoom: true, showCoverageOnHover: true,
                    zoomToBoundsOnClick: true, chunkedLoading: true, chunkProgress: updateProgressBar });
                // Add GeoJSON layer
                var geojson = L.geoJson(data, {onEachFeature: function (feature, layer) {
                    layer.bindPopup(feature.properties.data);
                }
                });
                markers.addLayer(geojson);
                case_layers.addLayer(markers);
                case_layers.addTo(map);
            });
            $("#ano").text(year.toString())
        }
        ;
        function updateProgressBar(processed, total, elapsed, layersArray) {
            if (elapsed > 1000) {
                // if it takes more than a second to load, display the progress bar:
                $("#progress").css("display", 'block');
                $("#progress-bar").css("width", Math.round(processed / total * 100) + '%');
            }

            if (processed === total) {
                // all markers processed - hide the progress bar:
                $("#progress").css("display", 'none');
            }
        }
        function main_map_init(map, options) {
            $(document).data('map', map)
            $("#ano").text("2010")
            var dataurl = '{% url "sinan" 2010 00%}';
            // Download GeoJSON via Ajax

            $.getJSON(dataurl, function (data) {
                // Add GeoJSON layer
                var geojson = L.geoJson(data, {onEachFeature: function (feature, layer) {
                    layer.bindPopup(feature.properties.data);
                }
                });
                var markers = L.markerClusterGroup({ spiderfyOnMaxZoom: false, showCoverageOnHover: true,
                    zoomToBoundsOnClick: true, chunkedLoading: true, chunkProgress: updateProgressBar });
                markers.addLayer(geojson);
                case_layers.addLayer(markers);
                case_layers.addTo(map);
            });
        }
    </script>


{% endblock %}

